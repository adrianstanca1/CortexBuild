(()=>{var a={};a.id=863,a.ids=[863],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{"use strict";a.exports=require("punycode")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:a=>{"use strict";a.exports=require("stream")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33717:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{POST:()=>B});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641);class v{constructor(a={}){this.minOccurrences=a.minOccurrences||2,this.timeWindowDays=a.timeWindowDays||7,this.confidenceThreshold=a.confidenceThreshold||.7}async analyzeEvent(a,b){let c=this.getRelevantEvents(a,b);if(c.length<this.minOccurrences)return null;let d=this.detectPatternType(a,c),e=this.calculateConfidence(c);if(e<this.confidenceThreshold)return null;let f=this.assessRiskLevel(a,c),g=this.extractAffectedEntities(c);return{id:`pattern_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,patternType:d,occurrences:c,frequency:c.length,timespan:{start:new Date(Math.min(...c.map(a=>a.timestamp.getTime()))),end:new Date(Math.max(...c.map(a=>a.timestamp.getTime())))},confidence:e,riskLevel:f,affectedEntities:g}}getRelevantEvents(a,b){let c=new Date;return c.setDate(c.getDate()-this.timeWindowDays),b.events.filter(b=>!(b.timestamp<c)&&b.agentType===a.agentType&&b.eventType===a.eventType&&(!!a.entity&&!!b.entity&&b.entity.type===a.entity.type&&b.entity.id===a.entity.id||!!a.location&&b.location===a.location))}detectPatternType(a,b){return"hse_sentinel"===a.agentType&&"critical"===a.severity?"safety_violation":"project_controls"===a.agentType&&b.some(a=>"delayed"===a.data.status||a.data.productivity<80)?"performance_degradation":"financial_forecaster"===a.agentType&&b.some(a=>a.data.variance>0||!0===a.data.overbudget)?"cost_overrun":a.data.delayed||a.data.behindSchedule?"schedule_delay":"recurring_issue"}calculateConfidence(a){let b=Math.min(a.length/5,1);return b+=a.filter(a=>(Date.now()-a.timestamp.getTime())/864e5<=3).length/a.length*.2,1===new Set(a.map(a=>a.severity)).size&&(b+=.1),Math.min(b,1)}assessRiskLevel(a,b){if("critical"===a.severity)return b.length>=3?"systemic":"critical";if("warning"===a.severity){if(b.length>=3)return"high";if(b.length>=2)return"medium"}return"hse_sentinel"===a.agentType?b.length>=2?"high":"medium":"low"}extractAffectedEntities(a){let b=new Map;return a.forEach(a=>{if(a.entity){let c=`${a.entity.type}_${a.entity.id}`;b.set(c,a.entity)}}),Array.from(b.values())}analyzeTrend(a){let b=a.occurrences.sort((a,b)=>a.timestamp.getTime()-b.timestamp.getTime()),c=[];for(let a=1;a<b.length;a++){let d=b[a].timestamp.getTime()-b[a-1].timestamp.getTime();c.push(d)}let d=c.reduce((a,b)=>a+b,0)/c.length,e="stable";if(c.length>=2){let a=c[c.length-1];a<.7*d?e="worsening":a>1.3*d&&(e="improving")}let f=a.timespan.end.getTime()-a.timespan.start.getTime(),g=a.frequency/(f/864e5),h="";if("worsening"===e){let a=Math.round(d/864e5*.7);h=`Next occurrence predicted in ${a} days if trend continues`}else if("improving"===e)h="Pattern appears to be resolving";else{let a=Math.round(d/864e5);h=`Next occurrence predicted in ${a} days`}return{direction:e,velocity:g,prediction:h}}}class w{constructor(a={}){this.maxQueries=a.maxQueries||5,this.queryTimeout=a.queryTimeout||3e4,this.minConfidence=a.minConfidence||.6}async analyze(a){let b=this.generateQueries(a),c=await this.executeQueries(b),d=this.synthesizeHypothesis(a,c),e=this.assessRisk(a,c);return{id:`hypothesis_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,pattern:a,hypothesis:d,supportingEvidence:c,confidence:this.calculateHypothesisConfidence(c),riskAssessment:e,generatedAt:new Date}}generateQueries(a){let b=[],c=a.affectedEntities[0];return"safety_violation"===a.patternType&&(b.push({targetAgent:"project_controls",question:`What is the current status of activities for ${c.name}? Are there any delays or productivity issues?`,context:{entityType:c.type,entityId:c.id,patternType:a.patternType},priority:"urgent"}),b.push({targetAgent:"financial_forecaster",question:`What is the contract structure for ${c.name}? Are there financial penalties for delays?`,context:{entityType:c.type,entityId:c.id},priority:"urgent"}),b.push({targetAgent:"commercial_guardian",question:`Has ${c.name} had previous contract violations or performance issues?`,context:{entityType:c.type,entityId:c.id},priority:"normal"})),"performance_degradation"===a.patternType&&(b.push({targetAgent:"financial_forecaster",question:`What is the budget status and cash flow for ${c.name}?`,context:{entityType:c.type,entityId:c.id},priority:"urgent"}),b.push({targetAgent:"quality_inspector",question:`Are there quality issues affecting ${c.name}'s work?`,context:{entityType:c.type,entityId:c.id},priority:"normal"})),"cost_overrun"===a.patternType&&(b.push({targetAgent:"project_controls",question:`What are the scope changes and variations for ${c.name}?`,context:{entityType:c.type,entityId:c.id},priority:"urgent"}),b.push({targetAgent:"commercial_guardian",question:`What claims or disputes are active for ${c.name}?`,context:{entityType:c.type,entityId:c.id},priority:"normal"})),b.slice(0,this.maxQueries)}async executeQueries(a){let b=[];for(let c of a)try{let a=await this.queryAgent(c);b.push(a)}catch(a){console.error(`Failed to query ${c.targetAgent}:`,a)}return b}async queryAgent(a){return{agentType:a.targetAgent,question:a.question,...{project_controls:{answer:"Activity is 3 days behind schedule. Productivity is 20% below planned.",data:{status:"delayed",delayDays:3,productivity:80,plannedProductivity:100},confidence:.9},financial_forecaster:{answer:"Contract is fixed-price with \xa31,000/day delay penalties.",data:{contractType:"fixed_price",penaltyPerDay:1e3,currency:"GBP",totalPenaltyRisk:3e3},confidence:.95},commercial_guardian:{answer:"No previous violations recorded. First-time issue.",data:{previousViolations:0,contractCompliance:"good"},confidence:.85},hse_sentinel:{answer:"Safety compliance historically good until this week.",data:{complianceScore:85,recentIncidents:3},confidence:.9},quality_inspector:{answer:"No quality issues detected in recent inspections.",data:{qualityScore:92,defects:0},confidence:.88}}[a.targetAgent],timestamp:new Date}}synthesizeHypothesis(a,b){let c=[];b.forEach(a=>{"project_controls"===a.agentType&&a.data.delayDays>0&&(c.push(`${a.data.delayDays} days behind schedule`),c.push(`productivity ${a.data.productivity}% of planned`)),"financial_forecaster"===a.agentType&&a.data.penaltyPerDay&&(c.push(`facing \xa3${a.data.penaltyPerDay}/day penalties`),c.push(`total penalty risk: \xa3${a.data.totalPenaltyRisk}`))});let d=a.affectedEntities[0],e="";return"safety_violation"===a.patternType&&(e=`${d.name} is exhibiting recurring safety violations (${a.frequency} incidents in ${this.getDaysBetween(a.timespan.start,a.timespan.end)} days). `,c.length>0&&(e+=`Analysis reveals the entity is ${c.join(", ")}. `),e+='This pattern suggests the subcontractor is under financial pressure and attempting to "cut corners" by skipping safety procedures to recover lost time. This behavior exposes the project to imminent risk of serious accident and potential legal consequences.'),"performance_degradation"===a.patternType&&(e=`${d.name} shows declining performance with ${c.join(", ")}. Root cause likely involves resource constraints, skill gaps, or external pressures affecting work quality.`),"cost_overrun"===a.patternType&&(e=`${d.name} experiencing cost overruns. ${c.join(", ")}. Likely causes include scope creep, inefficient processes, or unforeseen complications.`),e}calculateHypothesisConfidence(a){return 0===a.length?0:Math.min(a.reduce((a,b)=>a+b.confidence,0)/a.length+Math.min(a.length/5,.2),1)}assessRisk(a,b){let c,d=[],e=[];"safety_violation"===a.patternType&&(d.push("Worker Safety","Legal Compliance","Project Reputation"),e.push("Serious injury or fatality","HSE enforcement action","Project shutdown","Legal liability","Reputational damage"));let f=b.find(a=>"financial_forecaster"===a.agentType);f?.data.totalPenaltyRisk&&(d.push("Project Budget","Cash Flow"),c={min:f.data.totalPenaltyRisk,max:2*f.data.totalPenaltyRisk,currency:f.data.currency||"GBP"},e.push(`Financial penalties up to \xa3${c.max}`));let g=b.find(a=>"project_controls"===a.agentType);return g?.data.delayDays>0&&(d.push("Project Schedule","Milestone Delivery"),e.push(`${g.data.delayDays}+ days delay`,"Cascade effect on dependent activities","Client dissatisfaction")),{level:a.riskLevel,impactAreas:d,potentialConsequences:e,financialImpact:c}}getDaysBetween(a,b){return Math.round((b.getTime()-a.getTime())/864e5)}}class x{constructor(a={}){this.maxActionsPerLevel=a.maxActionsPerLevel||5}generateActionPlan(a){let b=this.generateSummary(a),c=this.generateImmediateActions(a);return{summary:b,immediateActions:c,shortTermActions:this.generateShortTermActions(a),strategicActions:this.generateStrategicActions(a)}}generateSummary(a){let b=a.pattern.affectedEntities[0],c=a.riskAssessment.level.toUpperCase(),d=`**${c} RISK DETECTED**: ${a.pattern.patternType.replace(/_/g," ").toUpperCase()}

`;if(d+=`**Entity**: ${b.name}
**Pattern**: ${a.pattern.frequency} incidents in ${this.getDaysBetween(a.pattern.timespan.start,a.pattern.timespan.end)} days
**Confidence**: ${Math.round(100*a.confidence)}%

**Root Cause Analysis**:
${a.hypothesis}

**Impact Areas**: ${a.riskAssessment.impactAreas.join(", ")}

`,a.riskAssessment.financialImpact){let b=a.riskAssessment.financialImpact;d+=`**Financial Impact**: ${b.currency} ${b.min.toLocaleString()} - ${b.max.toLocaleString()}

`}return d+`**Recommended Actions**: ${this.getActionCount(a)} actions across 3 priority levels`}generateImmediateActions(a){let b=[],c=a.pattern.affectedEntities[0];return"safety_violation"===a.pattern.patternType&&(b.push({id:`action_immediate_${Date.now()}_1`,priority:"immediate",category:"safety",title:"STOP WORK ORDER",description:`Immediately halt all work by ${c.name} until safety compliance is verified`,steps:[{order:1,action:`Issue Stop Work Order to ${c.name}`,assignedTo:"Site Manager",deadline:new Date(Date.now()+36e5)},{order:2,action:"Deploy HSE Sentinel AI for immediate site verification",assignedTo:"HSE Officer",deadline:new Date(Date.now()+72e5)},{order:3,action:"Photograph and document all safety violations",assignedTo:"HSE Officer",deadline:new Date(Date.now()+72e5)},{order:4,action:"Verify installation of all required safety measures",assignedTo:"HSE Officer",deadline:new Date(Date.now()+144e5),dependencies:["action_immediate_1_step_2"]}],expectedOutcome:"Work area secured, safety violations corrected, zero risk of accident",risks:["Work stoppage may cause schedule delays","Subcontractor may dispute order"],estimatedCost:0,estimatedDuration:"4 hours"}),b.push({id:`action_immediate_${Date.now()}_2`,priority:"immediate",category:"safety",title:"Emergency Safety Briefing",description:`Conduct mandatory safety briefing for all ${c.name} personnel`,steps:[{order:1,action:"Assemble all subcontractor personnel",assignedTo:"Site Manager",deadline:new Date(Date.now()+108e5)},{order:2,action:"Review safety violations and consequences",assignedTo:"HSE Officer",deadline:new Date(Date.now()+108e5)},{order:3,action:"Obtain signed acknowledgment from all workers",assignedTo:"HSE Officer",deadline:new Date(Date.now()+144e5)}],expectedOutcome:"All personnel aware of safety requirements and consequences",risks:[],estimatedDuration:"2 hours"})),b.slice(0,this.maxActionsPerLevel)}generateShortTermActions(a){let b=[],c=a.pattern.affectedEntities[0];return"safety_violation"===a.pattern.patternType&&(b.push({id:`action_short_${Date.now()}_1`,priority:"short_term",category:"commercial",title:"Contract Violation Notice",description:`Issue formal notice of contract breach to ${c.name}`,steps:[{order:1,action:"Commercial Guardian AI to draft violation notice",assignedTo:"Commercial Manager",deadline:new Date(Date.now()+864e5)},{order:2,action:"Legal review of notice",assignedTo:"Legal Team",deadline:new Date(Date.now()+1728e5)},{order:3,action:"Serve notice to subcontractor management",assignedTo:"Commercial Manager",deadline:new Date(Date.now()+2592e5)}],expectedOutcome:"Formal documentation of violations, legal protection established",risks:["May damage relationship","Potential dispute"],estimatedDuration:"3 days"}),b.push({id:`action_short_${Date.now()}_2`,priority:"short_term",category:"operational",title:"Corrective Action Meeting",description:`Emergency meeting with ${c.name} management to develop corrective action plan`,steps:[{order:1,action:"Schedule meeting with subcontractor senior management",assignedTo:"Project Manager",deadline:new Date(Date.now()+864e5)},{order:2,action:"Present pattern analysis and root cause findings",assignedTo:"Project Manager",deadline:new Date(Date.now()+1728e5)},{order:3,action:"Develop and agree corrective action plan",assignedTo:"Project Manager",deadline:new Date(Date.now()+1728e5)},{order:4,action:"Establish monitoring and reporting requirements",assignedTo:"Project Manager",deadline:new Date(Date.now()+1728e5)}],expectedOutcome:"Agreed corrective action plan with clear accountability",risks:["Subcontractor may not commit to plan"],estimatedDuration:"2 days"})),b.slice(0,this.maxActionsPerLevel)}generateStrategicActions(a){let b=[],c=a.pattern.affectedEntities[0];return b.push({id:`action_strategic_${Date.now()}_1`,priority:"strategic",category:"strategic",title:"Risk Register Update",description:"Update project risk register with new insights",steps:[{order:1,action:`Escalate risk: "${a.pattern.patternType}" to ${a.riskAssessment.level} level`,assignedTo:"Risk Manager",deadline:new Date(Date.now()+6048e5)},{order:2,action:"Update risk mitigation strategies",assignedTo:"Risk Manager",deadline:new Date(Date.now()+6048e5)},{order:3,action:"Present to project board",assignedTo:"Project Director",deadline:new Date(Date.now()+12096e5)}],expectedOutcome:"Risk register reflects current project reality",risks:[],estimatedDuration:"2 weeks"}),b.push({id:`action_strategic_${Date.now()}_2`,priority:"strategic",category:"strategic",title:"Contingency Planning",description:`Develop contingency plan for potential ${c.name} contract termination`,steps:[{order:1,action:"Project Controls AI to model impact of contract termination",assignedTo:"Planning Manager",deadline:new Date(Date.now()+6048e5)},{order:2,action:"Identify alternative subcontractors",assignedTo:"Procurement Manager",deadline:new Date(Date.now()+6048e5)},{order:3,action:"Estimate cost and schedule impact of transition",assignedTo:"Commercial Manager",deadline:new Date(Date.now()+12096e5)},{order:4,action:"Prepare contingency budget request",assignedTo:"Project Manager",deadline:new Date(Date.now()+12096e5)}],expectedOutcome:"Ready-to-execute contingency plan if needed",risks:["May signal lack of confidence to client"],estimatedCost:5e4,estimatedDuration:"2 weeks"}),b.slice(0,this.maxActionsPerLevel)}getActionCount(a){return"systemic"===a.riskAssessment.level||"critical"===a.riskAssessment.level?9:6}getDaysBetween(a,b){return Math.round((b.getTime()-a.getTime())/864e5)}}class y{constructor(a){this.config={patternDetection:{minOccurrences:2,timeWindowDays:7,confidenceThreshold:.7,...a?.patternDetection},rootCauseAnalysis:{maxQueries:5,queryTimeout:3e4,minConfidence:.6,...a?.rootCauseAnalysis},actionGeneration:{maxActionsPerLevel:5,requireApproval:!0,autoExecute:["notification","alert"],...a?.actionGeneration},notifications:{channels:["email","sms","in_app"],escalationRules:{low:["in_app"],medium:["in_app","email"],high:["in_app","email","sms"],critical:["in_app","email","sms","urgent"],systemic:["in_app","email","sms","urgent"]},...a?.notifications}},this.patternDetector=new v(this.config.patternDetection),this.rootCauseAnalyzer=new w(this.config.rootCauseAnalysis),this.actionGenerator=new x(this.config.actionGeneration)}async processEvent(a,b){console.log(`[Cognitive Core] Processing event: ${a.eventType} from ${a.agentType}`);let c=await this.patternDetector.analyzeEvent(a,b);if(!c)return console.log("[Cognitive Core] No significant pattern detected"),null;console.log(`[Cognitive Core] Pattern detected: ${c.patternType} (${c.frequency} occurrences, ${Math.round(100*c.confidence)}% confidence)`);let d=this.patternDetector.analyzeTrend(c);console.log(`[Cognitive Core] Trend: ${d.direction}, ${d.prediction}`),console.log("[Cognitive Core] Initiating root cause analysis...");let e=await this.rootCauseAnalyzer.analyze(c);console.log(`[Cognitive Core] Hypothesis generated (${Math.round(100*e.confidence)}% confidence):`),console.log(e.hypothesis),console.log("[Cognitive Core] Generating strategic action plan...");let f=this.actionGenerator.generateActionPlan(e);console.log("[Cognitive Core] Action plan generated:"),console.log(`- ${f.immediateActions.length} immediate actions`),console.log(`- ${f.shortTermActions.length} short-term actions`),console.log(`- ${f.strategicActions.length} strategic actions`);let g=this.generateNotifications(e,f),h={id:`cognitive_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,triggerEvent:a,detectedPattern:c,rootCauseAnalysis:{queries:[],responses:e.supportingEvidence,hypothesis:e},strategicPlan:f,notifications:g,generatedAt:new Date,expiresAt:new Date(Date.now()+6048e5)};return console.log("[Cognitive Core] Cognitive response generated successfully"),h}generateNotifications(a,b){let c=[],d=a.riskAssessment.level;return c.push({recipient:"project_manager",channel:this.config.notifications.escalationRules[d].includes("urgent")?"urgent":"email",message:this.formatNotificationMessage(a,b),priority:"systemic"===d||"critical"===d?"critical":"high"}),"safety_violation"===a.pattern.patternType&&c.push({recipient:"hse_officer",channel:"urgent",message:"URGENT: Recurring safety violations detected. Immediate action required.",priority:"critical"}),b.shortTermActions.some(a=>"commercial"===a.category)&&c.push({recipient:"commercial_manager",channel:"email",message:`Contract violation notice required for ${a.pattern.affectedEntities[0].name}`,priority:"high"}),"systemic"===d&&c.push({recipient:"project_director",channel:"urgent",message:`SYSTEMIC RISK: ${a.pattern.patternType.toUpperCase()} - Board escalation required`,priority:"critical"}),c}formatNotificationMessage(a,b){let c=a.pattern.affectedEntities[0],d=`🚨 COGNITIVE CORE ALERT

`;return d+=`Risk Level: ${a.riskAssessment.level.toUpperCase()}
Pattern: ${a.pattern.patternType.replace(/_/g," ").toUpperCase()}
Entity: ${c.name}
Confidence: ${Math.round(100*a.confidence)}%

Root Cause:
${a.hypothesis}

Immediate Actions Required:
`,b.immediateActions.forEach((a,b)=>{d+=`${b+1}. ${a.title}
`}),d+=`
View full strategic plan in ConstructAI dashboard.`}async getInsights(a){return{activePatterns:[],activeHypotheses:[],riskSummary:{systemic:0,critical:0,high:0,medium:0,low:0}}}async simulateScenario(){let a=[{id:"event_1",agentType:"hse_sentinel",timestamp:new Date(Date.now()-432e6),eventType:"safety_violation",severity:"critical",location:"Floor 5, North Zone",entity:{type:"subcontractor",id:"sub_001",name:"Instal Pro SRL"},data:{violation:"Missing edge protection",area:"Floor 5"}},{id:"event_2",agentType:"hse_sentinel",timestamp:new Date(Date.now()-2592e5),eventType:"safety_violation",severity:"critical",location:"Floor 5, North Zone",entity:{type:"subcontractor",id:"sub_001",name:"Instal Pro SRL"},data:{violation:"Missing edge protection",area:"Floor 5"}},{id:"event_3",agentType:"hse_sentinel",timestamp:new Date,eventType:"safety_violation",severity:"critical",location:"Floor 5, North Zone",entity:{type:"subcontractor",id:"sub_001",name:"Instal Pro SRL"},data:{violation:"Missing edge protection",area:"Floor 5"}}],b={projectId:"proj_001",timeWindow:{start:new Date(Date.now()-2592e6),end:new Date},events:a.slice(0,2),patterns:[],previousHypotheses:[]};return this.processEvent(a[2],b)}}var z=c(76466),A=c(76625);async function B(a){return(0,z.X0)(a,async(a,b)=>{try{let c=await a.json();if(!c.event||!c.event.agentType||!c.event.eventType)return u.NextResponse.json({error:"Invalid event data"},{status:400});let d={...c.event,timestamp:new Date(c.event.timestamp||Date.now())},e=await C(b.companyId,d.entity?.id||"unknown"),f=new y,g=await f.processEvent(d,e);if(!g)return u.NextResponse.json({message:"Event processed, no significant pattern detected",pattern:null});return await D(b.companyId,g),await E(g.notifications),u.NextResponse.json({message:"Cognitive analysis complete",response:{id:g.id,riskLevel:g.rootCauseAnalysis.hypothesis.riskAssessment.level,patternType:g.detectedPattern.patternType,confidence:g.rootCauseAnalysis.hypothesis.confidence,actionsGenerated:{immediate:g.strategicPlan.immediateActions.length,shortTerm:g.strategicPlan.shortTermActions.length,strategic:g.strategicPlan.strategicActions.length}}})}catch(a){return console.error("Cognitive process error:",a),u.NextResponse.json({error:"Failed to process event"},{status:500})}})}async function C(a,b){let c=await (0,A.lw)(a),d=new Date;d.setDate(d.getDate()-30);let{data:e}=await c.from("agent_events").select("*").eq("company_id",a).gte("timestamp",d.toISOString()).order("timestamp",{ascending:!1}),{data:f}=await c.from("detected_patterns").select("*").eq("company_id",a).eq("status","active"),{data:g}=await c.from("root_cause_hypotheses").select("*").eq("company_id",a).gte("generated_at",d.toISOString());return{projectId:b,timeWindow:{start:d,end:new Date},events:(e||[]).map(a=>({...a,timestamp:new Date(a.timestamp)})),patterns:f||[],previousHypotheses:g||[]}}async function D(a,b){let c=await (0,A.lw)(a);for(let d of(await c.from("detected_patterns").insert({company_id:a,pattern_type:b.detectedPattern.patternType,frequency:b.detectedPattern.frequency,confidence:b.detectedPattern.confidence,risk_level:b.detectedPattern.riskLevel,data:b.detectedPattern,status:"active"}),await c.from("root_cause_hypotheses").insert({company_id:a,hypothesis:b.rootCauseAnalysis.hypothesis.hypothesis,confidence:b.rootCauseAnalysis.hypothesis.confidence,risk_level:b.rootCauseAnalysis.hypothesis.riskAssessment.level,data:b.rootCauseAnalysis.hypothesis}),[...b.strategicPlan.immediateActions,...b.strategicPlan.shortTermActions,...b.strategicPlan.strategicActions]))await c.from("strategic_actions").insert({company_id:a,priority:d.priority,category:d.category,title:d.title,description:d.description,status:"pending",data:d})}async function E(a){a.forEach(a=>{console.log(`[Notification] ${a.channel} to ${a.recipient}:`),console.log(a.message)})}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/cognitive/process-event/route",pathname:"/api/cognitive/process-event",filename:"route",bundlePath:"app/api/cognitive/process-event/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/admin/Downloads/CortexBuild/app/api/cognitive/process-event/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/cognitive/process-event/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{"use strict";a.exports=require("zlib")},76466:(a,b,c)=>{"use strict";c.d(b,{X0:()=>g,kD:()=>j,sc:()=>i});var d=c(10641),e=c(76625);async function f(a){let b=a.headers.get("authorization");if(!b?.startsWith("Bearer "))return null;let c=b.substring(7);try{let a=JSON.parse(Buffer.from(c.split(".")[1],"base64").toString());return a.sub||a.userId}catch(a){return console.error("Failed to decode token:",a),null}}async function g(a,b){try{let c,g=await f(a);if(!g)return d.NextResponse.json({error:"Unauthorized - No valid token"},{status:401});try{c=await (0,e._D)(g)}catch(a){return d.NextResponse.json({error:"User company not found"},{status:403})}let i=await h(a);if(i&&i!==c)return console.warn(`Security violation: User ${g} attempted to access company ${i}`),d.NextResponse.json({error:"Forbidden - Access denied to this company"},{status:403});let j={userId:g,companyId:c,userRole:"user"};return await b(a,j)}catch(a){return console.error("Company context middleware error:",a),d.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(a){let b=a.nextUrl.searchParams.get("companyId");if(b)return b;try{let b=await a.clone().json();return b.companyId||b.company_id||null}catch{return null}}async function i(a,b,d,e,f,g){let{createServerClient:h}=await Promise.resolve().then(c.bind(c,76625)),i=h();await i.from("audit_logs").insert({company_id:a.companyId,user_id:a.userId,action:b,entity_type:d,entity_id:e,old_values:f,new_values:g,ip_address:null,user_agent:null})}async function j(a,b,d){let{createServerClient:e}=await Promise.resolve().then(c.bind(c,76625)),f=e(),{data:g,error:h}=await f.from(b).select("company_id").eq("id",d).single();return!h&&!!g&&g.company_id===a}},76625:(a,b,c)=>{"use strict";c.d(b,{ND:()=>g,_D:()=>j,createServerClient:()=>h,lw:()=>i});var d=c(53672);let e=process.env.NEXT_PUBLIC_SUPABASE_URL,f=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!f)throw Error("Missing Supabase environment variables");let g=(0,d.UU)(e,f,{auth:{persistSession:!0,autoRefreshToken:!0}}),h=()=>{let a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!a)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY");return(0,d.UU)(e,a,{auth:{persistSession:!1,autoRefreshToken:!1}})};async function i(a){let b=h(),{error:c}=await b.rpc("set_company_context",{company_id:a});if(c)throw console.error("Failed to set company context:",c),Error("Failed to set company context");return b}async function j(a){let b=h(),{data:c,error:d}=await b.from("users").select("company_id").eq("id",a).single();if(d||!c?.company_id)throw Error("User company not found");return c.company_id}},78335:()=>{},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},96487:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,1692,3672],()=>b(b.s=33717));module.exports=c})();